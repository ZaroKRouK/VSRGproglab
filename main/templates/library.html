<!DOCTYPE html>
<html lang="ru">
<head>
    {% load static %}

    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/library_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/vote_style.css' %}">
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Spice&display=swap" rel="stylesheet">

    <script src="https://api-maps.yandex.ru/2.1/?apikey=f1e92b69-4775-4ce5-b2a8-d8ba48b5cc0d&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
    <div class="nav_bar">
        <a href="{% url 'home' %}">–ì–ª–∞–≤–Ω–∞—è</a>
        {% if user.is_authenticated %}
            <span>–ü—Ä–∏–≤–µ—Ç, {{ user.username }}!</span>
            <a href="{% url 'logout' %}">–í—ã–π—Ç–∏</a>
        {% else %}
            <a href="{% url 'login' %}">–í–æ–π—Ç–∏</a>
            <a href="{% url 'register' %}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        {% endif %}
    </div>

    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="all_games">

        <div class="games" data-map-id="1">
            <img src="{% static 'images/DDRlogo.jpeg' %}" class="img_t" alt="DDR">
            <p>DDR</p>
            {% if user.is_authenticated %}
            <div class="vote-buttons">
                <button class="like-btn" onclick="vote(1, true)">üëç <span class="like-count">0</span></button>
                <button class="dislike-btn" onclick="vote(1, false)">üëé <span class="dislike-count">0</span></button>
            </div>
            {% else %}
            <div class="vote-display">
                <span>üëç <span class="like-count">0</span></span>
                <span>üëé <span class="dislike-count">0</span></span>
                <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å</p>
            </div>
            {% endif %}
        </div>

        <div class="games" data-map-id="2">
            <img src="{% static 'images/SoundVoltexLogo.jpeg' %}" class="img_t" alt="SDVX">
            <p>SDVX</p>
            {% if user.is_authenticated %}
            <div class="vote-buttons">
                <button class="like-btn" onclick="vote(2, true)">üëç <span class="like-count">0</span></button>
                <button class="dislike-btn" onclick="vote(2, false)">üëé <span class="dislike-count">0</span></button>
            </div>
            {% else %}
            <div class="vote-display">
                <span>üëç <span class="like-count">0</span></span>
                <span>üëé <span class="dislike-count">0</span></span>
                <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å</p>
            </div>
            {% endif %}
        </div>

        <div class="games" data-map-id="3">
            <img src="{% static 'images/etterna logo.jpeg' %}" class="img_t" alt="Etterna">
            <p>Etterna</p>
            {% if user.is_authenticated %}
            <div class="vote-buttons">
                <button class="like-btn" onclick="vote(3, true)">üëç <span class="like-count">0</span></button>
                <button class="dislike-btn" onclick="vote(3, false)">üëé <span class="dislike-count">0</span></button>
            </div>
            {% else %}
            <div class="vote-display">
                <span>üëç <span class="like-count">0</span></span>
                <span>üëé <span class="dislike-count">0</span></span>
                <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å</p>
            </div>
            {% endif %}
        </div>

        <div class="games" data-map-id="4">
            <img src="{% static 'images/o!m logo.jpeg' %}" class="img_t" alt="osu!mania">
            <p>osu!mania</p>
            {% if user.is_authenticated %}
            <div class="vote-buttons">
                <button class="like-btn" onclick="vote(4, true)">üëç <span class="like-count">0</span></button>
                <button class="dislike-btn" onclick="vote(4, false)">üëé <span class="dislike-count">0</span></button>
            </div>
            {% else %}
            <div class="vote-display">
                <span>üëç <span class="like-count">0</span></span>
                <span>üëé <span class="dislike-count">0</span></span>
                <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å</p>
            </div>
            {% endif %}
        </div>

    </div>

    <div style="margin: 100px auto; width: 80%;">
        <h3 style="text-align: center;">–ü–µ—Ä–≤—ã–π –∞–≤—Ç–æ–º–∞—Ç beatmania IIDX (1999)</h3>
        <div id="yandex-map" style="width: 100%; height: 400px; border: 1px solid #ddd;"></div>
    </div>

    <script>
        ymaps.ready(init);

        function init() {
            var map = new ymaps.Map("yandex-map", {
                center: [35.7000, 139.7730],
                zoom: 17,
                controls: ['zoomControl']
            });

            var placemark = new ymaps.Placemark([35.7000, 139.7730], {
                balloonContent: '–ü–µ—Ä–≤—ã–π –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –∞–≤—Ç–æ–º–∞—Ç beatmania IIDX<br>–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 1999 –≥–æ–¥—É –≤ Taito Station Akihabara'
            });

            map.geoObjects.add(placemark);
        }

        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function vote(mapId, isLike) {
            const csrfToken = getCookie('csrftoken');
            if (!csrfToken) {
                console.error('CSRF token –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            fetch('/api/vote/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    map_id: mapId,
                    is_like: isLike
                }),
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateVoteDisplay(mapId, data.likes, data.dislikes, data.user_vote);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:', data.error);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        }

        function updateVoteDisplay(mapId, likes, dislikes, userVote) {
            const gameDiv = document.querySelector(`[data-map-id="${mapId}"]`);
            const likeCount = gameDiv.querySelector('.like-count');
            const dislikeCount = gameDiv.querySelector('.dislike-count');
            const likeBtn = gameDiv.querySelector('.like-btn');
            const dislikeBtn = gameDiv.querySelector('.dislike-btn');

            likeCount.textContent = likes;
            dislikeCount.textContent = dislikes;

            
            if (likeBtn && dislikeBtn) {
                likeBtn.classList.remove('active');
                dislikeBtn.classList.remove('active');

                if (userVote === true) {
                    likeBtn.classList.add('active');
                } else if (userVote === false) {
                    dislikeBtn.classList.add('active');
                }
            }
        }

        
        // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≥–æ–ª–æ—Å–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/votes/`;
        const socket = new WebSocket(wsUrl);

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'vote_update') {
                updateVoteDisplay(data.map_id, data.likes, data.dislikes, data.user_vote);
            }
        };

        socket.onopen = function(event) {
            console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        };

        socket.onclose = function(event) {
            console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
        };

        socket.onerror = function(error) {
            console.error('–û—à–∏–±–∫–∞ WebSocket:', error);
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        function loadInitialStats() {
            fetch('/api/stats/')
            .then(response => response.json())
            .then(data => {
                data.maps.forEach(map => {
                    updateVoteDisplay(map.id, map.likes, map.dislikes, map.user_vote);
                });
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadInitialStats();
        });
    </script>
</body>
</html>
